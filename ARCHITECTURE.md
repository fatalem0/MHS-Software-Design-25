# Архитектура CLI

## Состав команды

- Цыганов Иван
- Новокшанов Евгений
- Борисов Михаил
- Кудимов Дмитрий

## Представление команд

Команда после обработки представляет собой dataclass
```rust
class Command
{
  Name: String
  Args: Vec<String>
  Stdin: Option<String>
  Stdout: Option<String>
}
```

## Представление pipeline
Пайплайн живет в объекте `Pipeliner`. Принимает вектор команд, открывает ФД через syscall `pipe()` и зовет раннеры команд, передавая нужную информацию об ФД.
```rust
class Pipeliner
{
  +Pipeline(cmds: Vec<Command>): Result<String, Error>
  -pipeStorage: Vec<(i32, i32)>
}
```

## Как создаются команды
Сырой ввод пропускается через конвейер обработки:
- InputProcessor получает строку от пользователя.

- PipeSplitter делит строку по пайпам (|) на части.

- Tokenizer разбивает каждую часть на токены, учитывая кавычки и экранирование.

- QuoteHandler обрабатывает кавычки.

- Expander подставляет переменные окружения через Environment.

- CommandProducer формирует из этого структуры Command (имя + аргументы + опциональное stdin/stdout перенаправление).

## Как они исполняются? Как взаимодействуют потоки в пайплайне?

- Main Loop запускает цикл обработки пользовательского ввода.

- После обработки ввода InputProcessor возвращает Vec<Command>.

- Pipeliner получает этот список, открывает нужное количество pipe-ов, получая набор ФД от операционки и запускает раннеров для каждой команды, передавая информацию о команде и ФД для перенаправления потоков

- Раннер делает fork и начинает исполнение команды в ребенке (разная логика для команд, имплементированных нами самостоятельно и общим случаем)

- Таким образом, каждая команда исполняется в отдельном процессе и они исполняются одновременно и взаимодействуют друг с другом через pipe'ы

## Как представляются переменные окружения
env переменные лежат в отдельном компоненте Environment, который хранит переменные в виде:
```
Environment {
    vars: HashMap<String, String>
}
```

## Фаза 1

Архитектура состоит из нескольких компонентов:  

- Main Loop - главный цикл программы, управляет последовательностью действий
- InputProcessor - обрабатывает пользовательский ввод
- Tokenizer - обрабатывает кавычки Возвращает вектор из команд и аргументов
- Command Processor - ищет подходящий о`бработчик для команды
- Runner - ищет подходящий выполнитель для команды

## Фаза 2

Архитектура состоит из нескольких компонентов:

- Main Loop - главный цикл программы, управляет последовательностью действий
- Environment - возвращает и сохраняет переменные окружения
- InputProcessor - обрабатывает пользовательский ввод
- Tokenizer - обрабатывает кавычки, подставляет переменные окружения, видит пайпы и обрабатывает команды относительно
  этого. Возвращает вектор из команд и аргументов
- Command Processor - ищет подходящий обработчик для команды
- Pipeliner - управляет выполнением команд, хранит результаты выполнения предыдущих команд (если пайпы)
- Runner - ищет подходящий выполнитель для команды